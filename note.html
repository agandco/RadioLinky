<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="https://i.imgur.com/vsqN1NZ.png">
    <link rel="icon" type="image/png" href="https://i.imgur.com/vsqN1NZ.png">
    <title>NOTE ELITE - GESTIONNAIRE</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #000000; 
            --text: #ffffff; 
            --accent: #ffffff;
            --contrast-text: #000000;
            /* Variables dynamiques pour le mode édition */
            --dynamic-bg: #1a1a1a;
            --dynamic-text: #ffffff;
            --dynamic-placeholder: rgba(255,255,255,0.5);
            --dynamic-border: rgba(255,255,255,0.2);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-transform: uppercase; user-select: none; -webkit-user-select: none; }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; }

        /* SCROLLBARS CACHÉES */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        .app-container { height: 100%; padding: 20px 15px 100px; overflow-y: auto; scroll-behavior: smooth; }
        
        /* HEADER & RECHERCHE */
        .header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .elite-text { color: var(--bg); text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; padding: 0 4px; letter-spacing: 2px; }
        
        .search-box input { 
            width: 100%; padding: 18px 20px; border-radius: 18px; 
            border: 2px solid #fff; 
            background: rgba(255,255,255,0.1); color: #fff; 
            font-family: inherit; font-weight: 700; font-size: 1rem;
            user-select: text; -webkit-user-select: text;
        }

        /* BOUTON AJOUT */
        .btn-add { width:100%; background: var(--accent); color: var(--contrast-text); padding:18px; border-radius:15px; font-weight:900; border: 2px solid #fff; margin: 20px 0; cursor: pointer; }

        /* LISTE DES NOTES */
        .category-group { margin-bottom: 15px; border: 2px solid #fff; border-radius: 18px; overflow: hidden; background: rgba(255,255,255,0.05); }
        .cat-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 0.9rem; cursor: pointer; background: rgba(255,255,255,0.05); }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        
        .note-card { 
            background: var(--card-bg); color: var(--card-text);
            border-radius: 16px; padding: 15px; 
            height: 160px; display: flex; flex-direction: column; 
            position: relative; overflow: hidden; 
            transition: transform 0.1s; border: 2px solid #fff;
        }
        .note-card:active { transform: scale(0.98); }
        
        .note-title { font-weight: 900; font-size: 0.85rem; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-preview { font-size: 0.7rem; font-weight: 600; opacity: 0.8; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; text-transform: none; }

        /* PANNEAU ÉDITION (FULLSCREEN) */
        #edit-panel { 
            position: fixed; inset: 0; 
            background: var(--dynamic-bg); color: var(--dynamic-text);
            z-index: 9999; display: none; flex-direction: column;
            transition: background 0.3s ease;
            height: 100%; width: 100%;
            /* Ajout pour permettre le scroll si le clavier réduit trop la vue */
            overflow-y: auto; 
        }

        .edit-header { 
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--dynamic-border);
            padding-top: max(20px, env(safe-area-inset-top));
            flex-shrink: 0; /* Empêche l'écrasement du header */
        }
        
        .edit-content-area { 
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        #live-title { 
            width: 100%; background: transparent; border: none; 
            color: var(--dynamic-text); font-family: inherit; font-weight: 900; 
            font-size: 1.8rem; margin-bottom: 15px; outline: none;
            user-select: text; -webkit-user-select: text;
        }
        
        #live-content { 
            width: 100%; flex: 1; background: transparent; border: none; 
            color: var(--dynamic-text); font-family: inherit; font-size: 1.1rem; 
            line-height: 1.6; outline: none; resize: none; text-transform: none;
            user-select: text; -webkit-user-select: text; min-height: 300px;
        }

        ::placeholder { color: var(--dynamic-placeholder); opacity: 1; }
        
        #options-drawer { 
            background: #000000; border-top: 2px solid var(--dynamic-border);
            padding: 20px; display: none;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            color: #ffffff;
            flex-shrink: 0; /* Empêche l'écrasement du drawer */
        }
        .form-row { margin-bottom: 15px; }
        .form-row label { font-size: 0.7rem; font-weight: 900; display: block; margin-bottom: 5px; opacity: 0.8; }
        
        select, input[type="text"] { 
            width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #fff;
            background: rgba(255,255,255,0.1); color: inherit; font-family: inherit; font-weight: 600;
        }
        
        input[type="color"] { width: 100%; height: 45px; border: 2px solid #fff; border-radius: 0px; background: transparent; cursor: pointer; }

        .hidden { display: none !important; }
        .status-indicator { font-size: 0.7rem; font-weight: 900; opacity: 0.5; margin-right: 10px; }
        
        :fullscreen { background: var(--dynamic-bg); width: 100vw; height: 100vh; }
        ::backdrop { background: var(--dynamic-bg); }

        /* Style pour la ligne de réglage couleur dans paramètres */
        .settings-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; 
            margin-bottom: 20px; border: 2px solid #fff;
        }
    </style>
</head>
<body>

<div class="app-container" id="main-view">
    <div class="header-row">
        <h1 style="font-weight:900; margin:0; font-size:1.5rem;">NOTE <span class="elite-text">ELITE</span></h1>
        <div style="display:flex; gap:20px;">
            <i data-lucide="arrow-down-up" id="sort-btn" onclick="toggleSortMode()" style="cursor:pointer;"></i>
            <i data-lucide="settings" onclick="document.getElementById('settings-panel').style.display='block'" style="cursor:pointer;"></i>
        </div>
    </div>

    <div class="search-box">
        <input type="text" id="search-input" placeholder="RECHERCHER..." oninput="renderNotes()">
    </div>

    <div id="sort-info" style="text-align:center; font-size:0.7rem; font-weight:700; margin:15px 0; color:#ff4444; display:none;">
        MODE DÉPLACEMENT ACTIVÉ (GLISSEZ LES NOTES)
    </div>

    <button class="btn-add" onclick="createNewNote()">+ NOUVELLE NOTE</button>

    <div id="notes-container"></div>
</div>

<div id="edit-panel">
    <div class="edit-header">
        <i data-lucide="chevron-left" onclick="closeEditor()" style="cursor:pointer;"></i>
        <div style="display:flex; align-items:center;">
            <span id="save-status" class="status-indicator"></span>
            <i data-lucide="sliders-horizontal" onclick="toggleOptions()" style="cursor:pointer;"></i>
        </div>
    </div>

    <div class="edit-content-area">
        <input type="text" id="live-title" placeholder="TITRE" oninput="triggerAutoSave()">
        <textarea id="live-content" placeholder="Écrivez votre note ici..." oninput="triggerAutoSave()"></textarea>
    </div>

    <div id="options-drawer">
        <div class="form-row">
            <label>CATÉGORIE</label>
            <select id="cat-select" onchange="handleCatChange(); triggerAutoSave();"></select>
            <input type="text" id="new-cat-input" placeholder="NOUVELLE CATÉGORIE" 
                   style="display:none; margin-top:10px;" 
                   oninput="triggerAutoSave()" 
                   onfocus="setTimeout(() => { this.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 300)">
        </div>
        <div class="form-row">
            <label>COULEUR</label>
            <input type="color" id="color-picker" oninput="updateLiveTheme(this.value); triggerAutoSave();">
        </div>
        <button onclick="deleteCurrentNote()" style="width:100%; background:rgba(255,0,0,0.2); color:#ffaaaa; border:2px solid #ff4444; padding:15px; border-radius:10px; font-weight:900; margin-top:10px;">SUPPRIMER</button>
    </div>
    <input type="hidden" id="current-note-id">
</div>

<div id="settings-panel" style="position:fixed; inset:0; background:#000; z-index:10000; padding:30px; display:none;">
    <div style="display:flex; justify-content:space-between; margin-bottom:40px;">
        <h2 style="font-weight:900;">PARAMÈTRES</h2>
        <i data-lucide="x" onclick="this.parentElement.parentElement.style.display='none'" style="cursor:pointer;"></i>
    </div>
    <div class="settings-row">
        <label style="font-weight:900; font-size: 0.8rem;">COULEUR ACCENT</label>
        <input type="color" id="accent-picker" oninput="updateStyle('accent', this.value)" style="width: 50px; height: 30px;">
    </div>
    <button onclick="exportData()" class="btn-add" style="margin-bottom:10px; background:#fff; color:#000;">SAUVEGARDER</button>
    <button onclick="document.getElementById('import-file').click()" class="btn-add" style="background:#fff; color:#000;">IMPORTER</button>
    <div style="font-size: 0.65rem; font-weight: 700; opacity: 0.6; text-align: center; margin: 15px 0 25px; line-height: 1.4; letter-spacing: 1px;">PENSEZ À FAIRE UNE SAUVEGARDE DANS LES PARAMÈTRES DE TEMPS EN TEMPS POUR GARDER UNE COPIE DE VOS DONNÉES.</div>
    <button onclick="resetDB()" class="btn-add" style="background:#ff4444; color:#fff; margin-top:5px;">TOUT EFFACER</button>
    <input type="file" id="import-file" hidden onchange="importData(this)">
</div>

<script>
    let notes = [];
    let isSortMode = false;
    let saveTimeout;
    let isDeleting = false; 
    const DB_NAME = "ELITE_NOTES_V2";

    // --- LOGIQUE ACCENT (IMPORTÉE DE LINKY) ---
    function getLuminance(hex) {
        const rgb = hex.replace(/^#/, '').match(/.{2}/g).map(x => parseInt(x, 16) / 255);
        const [r, g, b] = rgb.map(c => c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4));
        return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    function updateStyle(k, v) {
        document.documentElement.style.setProperty(`--${k}`, v);
        localStorage.setItem(`ELITE_NOTE_${k}`, v);
        if (k === 'accent') {
            const lum = getLuminance(v);
            document.documentElement.style.setProperty('--contrast-text', lum > 0.5 ? '#000' : '#fff');
        }
    }

    function loadSavedStyles() {
        const savedAccent = localStorage.getItem('ELITE_NOTE_accent') || '#ffffff';
        updateStyle('accent', savedAccent);
        document.getElementById('accent-picker').value = savedAccent;
    }

    // --- DB SETUP ---
    const getDB = () => new Promise(resolve => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("notes")) db.createObjectStore("notes", { keyPath: "id", autoIncrement: true });
        };
        req.onsuccess = e => resolve(e.target.result);
    });

    async function refreshNotes() {
        const db = await getDB();
        return new Promise(resolve => {
            const tx = db.transaction("notes", "readonly");
            tx.objectStore("notes").getAll().onsuccess = e => {
                notes = e.target.result || [];
                renderNotes();
                resolve();
            };
        });
    }

    function getContrastColor(hex) {
        const r = parseInt(hex.substr(1, 2), 16);
        const g = parseInt(hex.substr(3, 2), 16);
        const b = parseInt(hex.substr(5, 2), 16);
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? '#000000' : '#ffffff';
    }

    function renderNotes() {
        const container = document.getElementById('notes-container');
        const query = document.getElementById('search-input').value.toLowerCase();
        container.innerHTML = "";
        const filtered = notes.filter(n => (n.title || "").toLowerCase().includes(query) || (n.content || "").toLowerCase().includes(query));
        const categories = [...new Set(filtered.map(n => n.cat || 'DIVERS'))].sort();

        categories.forEach(cat => {
            const group = document.createElement('div');
            group.className = "category-group";
            const list = filtered.filter(n => (n.cat || 'DIVERS') === cat).sort((a,b) => (a.order||0) - (b.order||0));
            let html = `<div class="cat-header" onclick="this.nextElementSibling.classList.toggle('hidden')">
                <span>${cat} <span style="opacity:0.5; font-size:0.7em; margin-left:5px;">${list.length}</span></span>
                <i data-lucide="chevron-down" size="16"></i>
            </div><div class="grid-container">`;

            list.forEach(n => {
                const bg = n.color || '#1a1a1a';
                const textColor = getContrastColor(bg);
                html += `<div class="note-card" data-id="${n.id}" style="--card-bg:${bg}; --card-text:${textColor}" onclick="openEditor(${n.id})">
                    <div class="note-title">${n.title || 'SANS TITRE'}</div>
                    <div class="note-preview">${(n.content || '').replace(/\n/g, '<br>')}</div>
                    ${isSortMode ? '<div style="position:absolute; bottom:10px; right:10px;"><i data-lucide="grip-vertical" size="16"></i></div>' : ''}
                </div>`;
            });
            html += `</div>`;
            group.innerHTML = html;
            container.appendChild(group);

            if(isSortMode) {
                new Sortable(group.querySelector('.grid-container'), { animation: 150, delay: 100, onEnd: saveOrder });
            }
        });
        lucide.createIcons();
    }

    function createNewNote() { openEditor(null); }

    function openEditor(id) {
        if(isSortMode) return;
        isDeleting = false; 
        const panel = document.getElementById('edit-panel');
        const titleIn = document.getElementById('live-title');
        const contentIn = document.getElementById('live-content');
        const colorIn = document.getElementById('color-picker');
        const catSelect = document.getElementById('cat-select');
        const hiddenId = document.getElementById('current-note-id');
        const drawer = document.getElementById('options-drawer');

        drawer.style.display = 'none';
        document.getElementById('save-status').innerText = "";
        const cats = [...new Set(notes.map(n => n.cat || 'DIVERS'))].sort();
        catSelect.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('') + `<option value="NEW">+ NOUVELLE...</option>`;

        if (id) {
            const n = notes.find(x => x.id === id);
            if(!n) return;
            hiddenId.value = n.id;
            titleIn.value = n.title || "";
            contentIn.value = n.content || "";
            colorIn.value = n.color || "#1a1a1a";
            catSelect.value = n.cat || "DIVERS";
            updateLiveTheme(n.color || "#1a1a1a");
        } else {
            hiddenId.value = "";
            titleIn.value = "";
            contentIn.value = "";
            colorIn.value = "#1a1a1a";
            catSelect.value = "DIVERS";
            updateLiveTheme("#1a1a1a");
        }
        document.getElementById('new-cat-input').style.display = 'none';
        panel.style.display = 'flex';

        const elem = document.documentElement;
        if (elem.requestFullscreen) { elem.requestFullscreen().catch(() => {}); }
        else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
    }

    function updateLiveTheme(hex) {
        const root = document.documentElement;
        const contrast = getContrastColor(hex);
        root.style.setProperty('--dynamic-bg', hex);
        root.style.setProperty('--dynamic-text', contrast);
        root.style.setProperty('--dynamic-placeholder', contrast === '#ffffff' ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)');
        root.style.setProperty('--dynamic-border', contrast === '#ffffff' ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)');
        document.querySelector('meta[name="theme-color"]').setAttribute('content', hex);
    }

    function toggleOptions() {
        const d = document.getElementById('options-drawer');
        d.style.display = d.style.display === 'block' ? 'none' : 'block';
    }

    function handleCatChange() {
        const sel = document.getElementById('cat-select');
        document.getElementById('new-cat-input').style.display = sel.value === 'NEW' ? 'block' : 'none';
    }

    function closeEditor() {
        if (!isDeleting) saveNoteDirectly();
        document.getElementById('edit-panel').style.display = 'none';
        document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
        if (document.exitFullscreen && document.fullscreenElement) { document.exitFullscreen(); }
        else if (document.webkitExitFullscreen && document.webkitFullscreenElement) { document.webkitExitFullscreen(); }
    }

    function triggerAutoSave() {
        if (isDeleting) return;
        document.getElementById('save-status').innerText = "ENREGISTREMENT...";
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveNoteDirectly, 600);
    }

    async function saveNoteDirectly() {
        if (isDeleting) return;
        const idVal = document.getElementById('current-note-id').value;
        const title = document.getElementById('live-title').value;
        const content = document.getElementById('live-content').value;
        if(!idVal && !title && !content) return;

        let cat = document.getElementById('cat-select').value;
        if(cat === 'NEW') cat = document.getElementById('new-cat-input').value.trim().toUpperCase() || 'DIVERS';

        const noteData = {
            title: title,
            content: content,
            color: document.getElementById('color-picker').value,
            cat: cat,
            updated: Date.now()
        };

        const db = await getDB();
        const tx = db.transaction("notes", "readwrite");
        const store = tx.objectStore("notes");

        if(idVal) {
            const existing = notes.find(n => n.id === parseInt(idVal));
            noteData.id = parseInt(idVal);
            noteData.order = existing ? existing.order : 0;
            store.put(noteData);
        } else {
            noteData.order = 0;
            const req = store.add(noteData);
            req.onsuccess = (e) => { document.getElementById('current-note-id').value = e.target.result; };
        }

        tx.oncomplete = () => {
            document.getElementById('save-status').innerText = "SAUVEGARDÉ";
            refreshNotes();
            setTimeout(() => { document.getElementById('save-status').innerText = ""; }, 2000);
        };
    }

    async function deleteCurrentNote() {
        if(confirm("Supprimer cette note définitivement ?")) {
            isDeleting = true; 
            clearTimeout(saveTimeout);
            const id = parseInt(document.getElementById('current-note-id').value);
            if(id) {
                const db = await getDB();
                const tx = db.transaction("notes", "readwrite");
                tx.objectStore("notes").delete(id);
                tx.oncomplete = () => {
                    document.getElementById('edit-panel').style.display = 'none';
                    refreshNotes();
                    closeEditor();
                };
            } else {
                closeEditor();
            }
        }
    }

    async function saveOrder() {
        const db = await getDB();
        const tx = db.transaction("notes", "readwrite");
        const store = tx.objectStore("notes");
        document.querySelectorAll('.note-card').forEach((card, idx) => {
            const id = parseInt(card.dataset.id);
            const note = notes.find(n => n.id === id);
            if(note) { note.order = idx; store.put(note); }
        });
    }

    function toggleSortMode() {
        isSortMode = !isSortMode;
        document.getElementById('sort-info').style.display = isSortMode ? 'block' : 'none';
        document.getElementById('sort-btn').style.color = isSortMode ? '#ff4444' : '#fff';
        renderNotes();
    }

    async function exportData() {
        const data = JSON.stringify(notes, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `RADIOLINKY_NOTES_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                const db = await getDB();
                const tx = db.transaction("notes", "readwrite");
                const store = tx.objectStore("notes");
                imported.forEach(n => { delete n.id; store.add(n); });
                tx.oncomplete = () => { alert('Import réussi !'); refreshNotes(); };
            } catch(err) { alert('Erreur fichier invalide'); }
        };
        reader.readAsText(file);
    }

    async function resetDB() {
        if(confirm("ATTENTION : TOUTES LES NOTES SERONT EFFACÉES.")) {
            const db = await getDB();
            const tx = db.transaction("notes", "readwrite");
            tx.objectStore("notes").clear();
            tx.oncomplete = () => { refreshNotes(); document.getElementById('settings-panel').style.display='none'; };
        }
    }

    window.onload = () => {
        loadSavedStyles();
        refreshNotes();
    };
</script>
</body>
</html>
