<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="apple-touch-icon" href="https://i.imgur.com/vsqN1NZ.png">
    <link rel="icon" type="image/png" href="https://i.imgur.com/vsqN1NZ.png">
    <title>TUBE ELITE</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: #ffffff; 
            --bg: #000000; 
            --text: #ffffff; 
            --border: #ffffff; 
            --contrast-text: #000000; 
            --contrast-border: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-transform: uppercase; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Montserrat', sans-serif; 
            min-height: 100vh; 
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .app-container { min-height: 100vh; padding: 20px 15px 180px; width: 100%; scroll-behavior: smooth; }
        .elite-text { color: var(--bg); text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff, 0px 0px 3px #fff; padding: 0 2px; letter-spacing: 2px; }

        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { 
    flex: 1; 
    width: 0;           /* FORCE l'égalité stricte peu importe le contenu */
    min-width: 0;       /* Sécurité pour éviter que le texte ne bloque le flex */
    padding: 15px 5px;  /* Réduit un peu le padding sur les côtés pour les petits écrans */
    border-radius: 15px; 
    border: 2px solid var(--contrast-border); 
    background: rgba(255,255,255,0.05); 
    color: #fff; 
    font-weight: 800; 
    font-size: 0.7rem;  /* Taille adaptée pour que 3 boutons tiennent côte à côte */
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 5px; 
    cursor: pointer;
    white-space: nowrap; /* Empêche le texte de revenir à la ligne */
    overflow: hidden;    /* Coupe ce qui dépasse si l'écran est vraiment trop petit */
}

        .tab-btn.active { background: var(--accent); color: var(--contrast-text); border-color: var(--contrast-border); }

        /* Style du message informatif */
        .info-search { 
            display: none; /* Caché par défaut */
            background: rgba(255,255,255,0.1); 
            border-left: 4px solid var(--accent); 
            padding: 12px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            font-size: 0.75rem; 
            line-height: 1.4;
            font-weight: 600;
        }

        .search-box { position: relative; margin-bottom: 20px; display: flex; gap: 10px; }
        .search-box input { flex: 1; padding: 18px 20px; border-radius: 18px; border: 2px solid #fff; background: rgba(255,255,255,0.1); color: #fff; font-family: inherit; font-weight: 600; font-size: 1rem; }
        .search-btn { background: var(--accent); color: var(--contrast-text); border: none; padding: 0 20px; border-radius: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .category-group { background: rgba(255,255,255,0.05); border-radius: 18px; margin-bottom: 10px; border: 2px solid #ffffff; overflow: hidden; }
        .cat-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 800; }
        .grid-container { display: none; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 12px; }

        .video-card { 
            background: linear-gradient(to bottom, var(--accent) -200%, #000 100%);
            border-radius: 20px; padding: 0px; text-align: center; border: 2px solid #fff; height: 130px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        .card-art { width: 135px; height: 80px; border-radius: 10px; object-fit: cover; border: 2px solid #fff; margin-bottom: 10px; background: #1a1a1a; pointer-events: none; }

        .title-box { width: 100%; overflow: hidden; white-space: nowrap; position: relative; padding: 0 5px; pointer-events: none; }
        .marquee { display: inline-block; padding-left: 100%; animation: scroll linear infinite; font-weight: 900; font-size: 0.7rem; }
        .no-scroll { padding-left: 0 !important; animation: none !important; width: 100%; text-align: center; text-overflow: ellipsis; overflow: hidden; display: block; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        #settings-panel, #edit-panel { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: none; padding: 30px; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 900; margin-bottom: 8px; font-size: 0.75rem; opacity: 0.7; }
        .form-group input, .form-group select { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #fff; background: rgba(255,255,255,0.05); color: #fff; font-family: inherit; }
        .color-row { background: rgba(255,255,255,0.05); padding: 18px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #fff; }

        .btn-action { width: 100%; background: var(--accent); color: var(--contrast-text); padding: 20px; border-radius: 15px; font-weight: 900; border: 2px solid var(--contrast-border); cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
        <h1 style="font-weight:900; margin:0;">TUBE <span class="elite-text">ELITE</span></h1>
        <i data-lucide="settings" onclick="toggleSettings(true)" style="cursor:pointer;"></i>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" id="tab-favs"><i data-lucide="play-circle"></i> MA LISTE</button>
        <button class="tab-btn" onclick="window.open('https://cafepia.fr', '_blank')">
    <i data-lucide="download"></i> MP3
</button>

        <button class="tab-btn" id="tab-add" onclick="openEditForm()"><i data-lucide="plus-circle"></i> NOUVEAU</button>
    </div>

    <div id="section-favs">
        <div id="info-box" class="info-search">
    Recherchez une vidéo, copiez son lien sur YouTube en appuyant sur les trois petits points du menu et "Partager", puis ajoutez-le via le bouton "Nouveau" ou sur "MP3".<br><br>
            POUR MODIFIER OU SUPPRIMER UNE VIDÉO, RESTEZ APPUYÉ LONGUEMENT DESSUS.
        </div>

        <div class="search-box">
            <div style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); z-index: 10; cursor: pointer;" onclick="toggleInfo()">
                <i data-lucide="info" style="width:20px; height:20px; color: var(--accent);"></i>
            </div>
            <input type="text" id="tube-search" style="padding-left: 45px; width:100%" placeholder="Rechercher..." oninput="filterLibrary(this.value)">
            <button class="search-btn" onclick="externalSearch()"><i data-lucide="search"></i></button>
        </div>
        <div id="favs-accordion-container"></div>
    </div>
</div>

<div id="edit-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="font-weight:900; margin:0;" id="form-title">AJOUTER TUBE</h2>
        <i data-lucide="x" onclick="document.getElementById('edit-panel').style.display='none'"></i>
    </div>
    <div style="text-align:center; margin-bottom:20px;">
        <img id="form-preview" src="https://www.pixartprinting.fr/blog/wp-content/uploads/2025/05/Youtube_logo.jpg" style="width:140px; height:90px; border-radius:15px; border:2px solid var(--contrast-border); object-fit:cover;">
    </div>
    <input type="hidden" id="edit-id">
    
    <div class="form-group"><label>URL YOUTUBE</label><input type="text" id="f-url" oninput="updatePreviewFromUrl()"></div>
    <div class="form-group"><label>NOM DU SET / VIDÉO</label><input type="text" id="f-name"></div>
    
    <div class="form-group">
        <label>CATÉGORIE</label>
        <select id="f-cat-select" onchange="toggleNewCat()"></select>
        <input type="text" id="f-cat-new" placeholder="Nom de la nouvelle catégorie" style="display:none; margin-top:10px;">
    </div>
    <button onclick="saveTube()" class="btn-action">ENREGISTRER</button>
    <button id="btn-delete" onclick="deleteTube()" style="display:none; width:100%; background:#ff4444; color:#fff; padding:15px; border-radius:15px; font-weight:900; border:none; margin-top:15px;">SUPPRIMER CE TUBE</button>
</div>

<div id="settings-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:40px;">
        <h2 style="font-weight:900; margin:0;">PARAMÈTRES</h2>
        <i data-lucide="x" onclick="toggleSettings(false)"></i>
    </div>
    <div class="color-row">
        <label style="font-weight:900;">COULEUR ACCENT</label>
        <input type="color" id="accent-picker" oninput="updateStyle('accent', this.value)">
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
        <button onclick="exportData()" style="padding:15px; border-radius:12px; background:#fff; color:#000; font-weight:800; border:none;">SAUVEGARDER</button>
        <button onclick="document.getElementById('import-input').click()" style="padding:15px; border-radius:12px; background:#fff; color:#000; font-weight:800; border:none;">IMPORTER</button>
    </div>
    <input type="file" id="import-input" hidden onchange="importData(this)">
    
    <div style="font-size: 0.65rem; font-weight: 700; opacity: 0.6; text-align: center; margin: 15px 0 25px; line-height: 1.4; letter-spacing: 1px;">
        PENSEZ À FAIRE UNE SAUVEGARDE DANS LES PARAMÈTRES DE TEMPS EN TEMPS POUR GARDER UNE COPIE DE VOS DONNÉES.
    </div>
</div>

<script>
    let library = [], pressTimer;
    const DB_NAME = "ELITE_TUBE_DB";

    window.onload = () => {
        loadSavedStyles();
        loadData();
    };

    function toggleInfo() {
        const info = document.getElementById('info-box');
        info.style.display = (info.style.display === 'block') ? 'none' : 'block';
    }

    function loadSavedStyles() {
        const savedAccent = localStorage.getItem('ELITE_TUBE_accent') || '#ffffff';
        updateStyle('accent', savedAccent);
        document.getElementById('accent-picker').value = savedAccent;
    }

    function updateStyle(k, v) {
        document.documentElement.style.setProperty(`--${k}`, v);
        localStorage.setItem(`ELITE_TUBE_${k}`, v);
        const rgb = v.replace(/^#/, '').match(/.{2}/g).map(x => parseInt(x, 16) / 255);
        const lum = 0.2126 * rgb[0] + 0.7152 * rgb[1] + 0.0722 * rgb[2];
        document.documentElement.style.setProperty('--contrast-text', lum > 0.5 ? '#000' : '#fff');
        document.documentElement.style.setProperty('--contrast-border', lum < 0.3 ? '#ffffff' : v);
    }

    const openDB = () => new Promise(res => {
        let req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore("tubes", {keyPath: "id", autoIncrement: true});
        req.onsuccess = e => res(e.target.result);
    });

    async function loadData() {
        const db = await openDB();
        db.transaction("tubes").objectStore("tubes").getAll().onsuccess = (e) => {
            library = e.target.result;
            renderLibrary();
        };
    }

    function extractID(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    async function updatePreviewFromUrl() {
        const urlVal = document.getElementById('f-url').value;
        const id = extractID(urlVal);
        if(id) {
            document.getElementById('form-preview').src = `https://img.youtube.com/vi/${id}/mqdefault.jpg`;
            
            // Récupération automatique du titre via oEmbed
            try {
                const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.title && !document.getElementById('edit-id').value) {
                        document.getElementById('f-name').value = data.title.toUpperCase();
                    }
                }
            } catch (err) {
                console.log("Erreur lors de la récupération du titre");
            }
        }
    }

    function filterLibrary(val) {
        renderLibrary(val.toLowerCase());
    }

    function externalSearch() {
        const q = document.getElementById('tube-search').value;
        if(q) window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`, '_blank');
    }

    function renderLibrary(filter = "") {
        const container = document.getElementById('favs-accordion-container');
        container.innerHTML = "";

        const filtered = library
            .filter(t => t.name.toLowerCase().includes(filter))
            .sort((a, b) => a.name.localeCompare(b.name));

        const cats = [...new Set(filtered.map(t => t.cat || 'DIVERS'))].sort();

        cats.forEach(cat => {
            const group = document.createElement('div');
            group.className = "category-group";
            const catTubes = filtered.filter(t => (t.cat || 'DIVERS') === cat);

            group.innerHTML = `
                <div class="cat-header" onclick="toggleAccordion(this)">
                    <span>${cat} (${catTubes.length})</span><i data-lucide="chevron-down"></i>
                </div>
                <div class="grid-container">
                    ${catTubes.map(t => `
                        <div class="video-card" 
                             onmousedown="startPress(${t.id})" ontouchstart="startPress(${t.id})"
                             onmouseup="cancelPress()" ontouchend="cancelPress()"
                             onclick="playTube('${t.yid}')">
                            <img src="https://img.youtube.com/vi/${t.yid}/mqdefault.jpg" class="card-art">
                            <div class="title-box"><span class="marquee">${t.name}</span></div>
                        </div>
                    `).join('')}
                </div>`;
            container.appendChild(group);
        });
        lucide.createIcons();
        checkMarquees();
    }

    function toggleAccordion(el) {
        const grid = el.nextElementSibling;
        const icon = el.querySelector('i');
        const isOpen = grid.style.display !== 'none';
        grid.style.display = isOpen ? 'none' : 'grid';
        if(icon) icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
    }

    function playTube(yid) {
        window.open(`https://www.youtube.com/watch?v=${yid}`, '_blank');
    }

    function toggleNewCat() {
        document.getElementById('f-cat-new').style.display = document.getElementById('f-cat-select').value === 'NEW' ? 'block' : 'none';
    }

    function openEditForm(id = null) {
        cancelPress();
        const panel = document.getElementById('edit-panel');
        panel.style.display = 'block';
        const select = document.getElementById('f-cat-select');
        const cats = [...new Set(library.map(t => t.cat || 'DIVERS'))].sort();
        select.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('') + '<option value="NEW">+ NOUVELLE...</option>';

        if(id) {
            const t = library.find(x => x.id === id);
            document.getElementById('edit-id').value = t.id;
            document.getElementById('f-name').value = t.name;
            document.getElementById('f-url').value = `https://www.youtube.com/watch?v=${t.yid}`;
            document.getElementById('f-cat-select').value = t.cat;
            document.getElementById('form-preview').src = `https://img.youtube.com/vi/${t.yid}/mqdefault.jpg`;
            document.getElementById('btn-delete').style.display = 'block';
            document.getElementById('form-title').innerText = "MODIFIER TUBE";
        } else {
            document.getElementById('edit-id').value = "";
            document.getElementById('f-name').value = "";
            document.getElementById('f-url').value = "";
            document.getElementById('form-preview').src = "https://www.pixartprinting.fr/blog/wp-content/uploads/2025/05/Youtube_logo.jpg";
            document.getElementById('btn-delete').style.display = 'none';
            document.getElementById('form-title').innerText = "AJOUTER TUBE";
        }
        lucide.createIcons();
    }

    async function saveTube() {
        const db = await openDB();
        const urlVal = document.getElementById('f-url').value;
        const yid = extractID(urlVal);
        if(!yid) return alert("URL YOUTUBE INVALIDE");
        
        let cat = document.getElementById('f-cat-select').value;
        if(cat === 'NEW') cat = document.getElementById('f-cat-new').value.toUpperCase() || 'DIVERS';
        
        let name = document.getElementById('f-name').value.toUpperCase();
        if(!name) name = "SANS TITRE";

        const tube = { name: name, yid: yid, cat: cat };
        const id = document.getElementById('edit-id').value;
        if(id) tube.id = parseInt(id);

        const tx = db.transaction("tubes", "readwrite");
        tx.objectStore("tubes").put(tube);
        tx.oncomplete = () => {
            document.getElementById('edit-panel').style.display = 'none';
            loadData();
        };
    }

    async function deleteTube() {
        if(!confirm("SUPPRIMER CE TUBE ?")) return;
        const db = await openDB();
        const id = parseInt(document.getElementById('edit-id').value);
        db.transaction("tubes", "readwrite").objectStore("tubes").delete(id).onsuccess = () => {
            document.getElementById('edit-panel').style.display = 'none';
            loadData();
        };
    }

    function startPress(id) { pressTimer = setTimeout(() => openEditForm(id), 1000); }
    function cancelPress() { clearTimeout(pressTimer); }
    function toggleSettings(s) { document.getElementById('settings-panel').style.display = s ? 'block' : 'none'; }

    function checkMarquees() {
        document.querySelectorAll('.title-box').forEach(box => {
            const span = box.querySelector('.marquee');
            if(span) {
                span.classList.add('no-scroll');
                if (span.scrollWidth > box.offsetWidth) {
                    span.classList.remove('no-scroll');
                    const duration = Math.max(5, span.scrollWidth / 30);
                    span.style.animationDuration = `${duration}s`;
                }
            }
        });
    }

    async function exportData() {
    const db = await openDB();
    const transaction = db.transaction("tubes", "readonly");
    const store = transaction.objectStore("tubes");
    const request = store.getAll();

    request.onsuccess = (e) => {
        const data = e.target.result;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        // Format du nom : RADIOLINKY_TUBE_2026-02-02.json
        a.download = `RADIOLINKY_TUBE_${new Date().toISOString().slice(0, 10)}.json`;
        
        // Ajout temporaire au document pour garantir le clic sur certains navigateurs mobiles
        document.body.appendChild(a);
        a.click();
        
        // Nettoyage immédiat
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    request.onerror = (err) => {
        console.error("Erreur lors de l'export :", err);
        alert("Erreur lors de l'exportation des données.");
    };
}

        async function importData(input) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                const db = await openDB();
                
                // 1. Récupérer les IDs YouTube déjà existants pour éviter les doublons
                const transactionRead = db.transaction("tubes", "readonly");
                const currentData = await new Promise(resolve => {
                    transactionRead.objectStore("tubes").getAll().onsuccess = (ev) => resolve(ev.target.result);
                });
                const existingYids = new Set(currentData.map(item => item.yid));

                // 2. Lancer la transaction d'écriture
                const tx = db.transaction("tubes", "readwrite");
                const store = tx.objectStore("tubes");
                
                let importCount = 0;
                data.forEach(t => { 
                    // On ne rajoute que si le yid n'est pas déjà présent
                    if (!existingYids.has(t.yid)) {
                        const item = {...t};
                        delete item.id; // On laisse IndexedDB générer un nouvel ID unique
                        store.add(item); 
                        importCount++;
                    }
                });

                tx.oncomplete = () => { 
                    alert(`IMPORT RÉUSSI : ${importCount} NOUVEAUX TUBES AJOUTÉS.`); 
                    loadData(); 
                };
            } catch (err) { 
                alert("ERREUR LORS DE L'IMPORTATION"); 
            }
        };
        reader.readAsText(input.files[0]);
    }

</script>
</body>
</html>
