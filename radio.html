<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="apple-touch-icon" href="https://i.imgur.com/vsqN1NZ.png">
    <link rel="icon" type="image/png" href="https://i.imgur.com/vsqN1NZ.png">
    <title>RADIOLINKY</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: #ffffff; 
            --bg: #000000; 
            --text: #ffffff; 
            --viz: #000000; 
            --border: #ffffff; 
            --contrast-text: #000000; 
            --contrast-border: #ffffff;
            --clock-color: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; min-height: 100vh; overflow-x: hidden; }

        .app-container { min-height: 100vh; padding: 20px 15px 180px; width: 100%; scroll-behavior: smooth; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .is-spinning { animation: rotate 10s linear infinite !important; }
        
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; border-radius: 15px; border: 2px solid var(--contrast-border); background: rgba(255,255,255,0.05); color: #fff; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .tab-btn.active { background: var(--accent); color: var(--contrast-text); border-color: var(--contrast-border); }

        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 18px 20px; border-radius: 18px; border: 2px solid #fff; background: rgba(255,255,255,0.1); color: #fff; font-family: inherit; font-weight: 700; font-size: 1rem; user-select: text; -webkit-user-select: text; }

        .category-group { background: rgba(255,255,255,0.05); border-radius: 18px; margin-bottom: 12px; border: 2px solid #ffffff; overflow: hidden; }
        .cat-header { padding: 18px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 800; }

        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 12px; }

        .info-tip { font-size: 0.65rem; font-weight: 700; opacity: 0.7; margin-bottom: 20px; text-align: center; letter-spacing: 1px; }

        .music-card { 
            background: linear-gradient(to bottom, var(--accent) -200%, #000 100%);
            border-radius: 20px; padding: 12px; text-align: center; border: 2px solid #fff; height: 180px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        
        /* Correction : Bordure forcée via contrast-border pour la carte en lecture */
        .playing-this { border: 3px solid var(--contrast-border) !important; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .card-art { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; margin-bottom: 10px; background: #1a1a1a; }
        
        .title-box { width: 100%; overflow: hidden; white-space: nowrap; position: relative; pointer-events: none; }
        .marquee { display: inline-block; padding-left: 100%; animation: scroll linear infinite; font-weight: 900; }
        .no-scroll { padding-left: 0 !important; animation: none !important; width: 100%; text-align: center; text-overflow: ellipsis; overflow: hidden; display: block; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Correction : Bordure mini-player via contrast-border */
        #mini-player { 
            position: fixed; bottom: 20px; left: 10px; right: 10px; height: 85px; 
            background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); 
            border: 2px solid var(--contrast-border); border-radius: 25px; 
            display: flex; align-items: center; padding: 0 15px; z-index: 1000; 
            cursor: pointer;
        }
        
        #fullscreen-player { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; align-items: center; padding: 40px 20px; }

        .btn-circle { width: 55px; height: 55px; border-radius: 50%; background: var(--accent); color: var(--contrast-text); border: 2px solid var(--contrast-border); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .btn-mini-play { 
            width: 53px; height: 53px; 
            border: 2px solid var(--contrast-border); 
            padding: 2px;
            background-clip: content-box; 
            background-color: var(--accent);
        }

        #settings-panel, #edit-panel { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: none; padding: 30px; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 900; margin-bottom: 8px; font-size: 0.8rem; }
        .form-group input, .form-group select { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #fff; background: rgba(255,255,255,0.05); color: #fff; font-family: inherit; }

        .color-row { background: rgba(255,255,255,0.05); padding: 18px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1); }

        #fs-viz { position: absolute; bottom: 0; left: 0; width: 100%; height: 200px; pointer-events: none; }
        .btn-switch { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.1); color: #fff; border: 2px solid #fff; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2100; cursor: pointer; transition: 0.3s; }
        .btn-switch:active { transform: scale(0.9); background: var(--accent); color: var(--contrast-text); }
        
        .btn-fix-fs { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); color: #fff; border: 2px solid #fff; width: 45px; height: 45px; border-radius: 50%; display: none; align-items: center; justify-content: center; z-index: 2100; cursor: pointer; }

        .elite-text { color: var(--bg); text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff, 0px 0px 3px #fff; padding: 0 2px;
        letter-spacing: 2px;
        }
        .ctrl-opt { opacity: 0.3; transition: 0.3s; cursor: pointer; }
        
        /* Correction : Bordure sur l'icône favori pour qu'elle soit visible même si l'accent est noir */
        .card-fav-icon { position: absolute; top: 10px; right: 10px; color: #fff; z-index: 10; filter: drop-shadow(0 0 2px #000); }
        .card-fav-icon.is-fav { color: var(--accent); fill: var(--accent); stroke: var(--contrast-border); stroke-width: 2px; }
        
        * { text-transform: uppercase; }
        #fullscreen-area { position: absolute; top:0; left:0; width:100%; height:85%; z-index: 5; }
    </style>
</head>
<body oncontextmenu="if(event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') return false;">

<div class="app-container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
    <h1 style="font-weight:900; margin:0;">RADIO <span class="elite-text">ELITE</span></h1>
        <i data-lucide="settings" onclick="toggleSettings(true)" style="cursor:pointer;"></i>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" id="tab-search" onclick="switchTab('search')"><i data-lucide="compass"></i> EXPLORER</button>
        <button class="tab-btn" id="tab-favs" onclick="switchTab('favs')"><i data-lucide="star"></i> FAVORIS</button>
    </div>

    <div id="section-search">
        <div class="search-box">
            <input type="text" id="radio-q" placeholder="Rechercher une station..." oninput="autoSearch()">
        </div>
        <div id="search-results" class="grid-container"></div>
    </div>

    <div id="section-favs" style="display:none;">
        <div class="info-tip" id="info-text">POUR MODIFIER APPUYEZ<br>LONGUEMENT SUR UNE RADIO</div>
        <button onclick="openEditForm()" style="width:100%; background:var(--accent); color:var(--contrast-text); padding:20px; border-radius:15px; font-weight:900; border:2px solid var(--contrast-border); margin-bottom:20px;">+ AJOUTER MANUELLEMENT</button>
        <div id="favs-accordion-container"></div>
    </div>
</div>

<div id="mini-player" onclick="requestFullScreen(); openFullscreen()">
    <button class="btn-circle btn-mini-play" onclick="event.stopPropagation(); togglePlay()">
        <i data-lucide="play" id="btn-play-mini" style="color: inherit;"></i>
    </button>
    <div style="flex:1; margin:0 15px; overflow:hidden; pointer-events: none;" class="title-box">
        <span id="mini-title" class="marquee" style="font-size:0.85rem; color: #fff;">Sélectionnez une radio</span>
    </div>
    <img id="mini-art" src="https://i.imgur.com/vsqN1NZ.png" style="width:55px; height:55px; border-radius:50%; object-fit:cover; border:2px solid var(--contrast-border); pointer-events: none;">
</div>

<div id="fullscreen-player">
    <div id="fullscreen-area" onclick="requestFullScreen()"></div>
    <div class="btn-switch" onclick="switchViz()"><i data-lucide="audio-lines" size="20"></i></div>
    
    <div class="btn-fix-fs" id="btn-fix-fs" onclick="requestFullScreen()"><i data-lucide="maximize" size="20"></i></div>

    <div style="position:relative; width:340px; height:340px; display:flex; align-items:center; justify-content:center; margin-top:20px;">
        <canvas id="viz-circle" width="340" height="340" style="position:absolute; top:0; left:0; pointer-events:none;"></canvas>
        <img id="fs-art" src="https://i.imgur.com/vsqN1NZ.png" style="width:210px; height:210px; border-radius:50%; border:4px solid #fff; object-fit:cover; z-index:5;">
    </div>
    <div style="margin-top:40px; text-align:center; z-index:10; width: 100%; padding: 0 20px;">
        <div id="fs-clock" style="color:var(--clock-color); font-weight:700; margin-bottom:15px; letter-spacing: 2px;">00:00:00</div>
        <div class="title-box" style="height:40px;"><span id="fs-title" class="marquee" style="font-size:1.6rem; color:#fff;">Titre Radio</span></div>
    </div> <div style="display:flex; width:100%; justify-content:space-around; align-items:center; margin-top:30px; z-index:10; padding:0 20px;">
        <i data-lucide="timer" class="ctrl-opt" onclick="toggleTimer()" size="30"></i>
        <button class="btn-circle btn-mini-play" onclick="togglePlay()"><i data-lucide="play" id="btn-play-fs" size="30" style="color: inherit;"></i></button>
        <i data-lucide="share-2" class="ctrl-opt" onclick="shareStation()" size="30"></i>
    </div>

    <canvas id="fs-viz"></canvas>
    <i data-lucide="chevron-down" style="position:absolute; bottom:30px; transform:scale(1); cursor:pointer;" onclick="closeFullscreen()"></i>
</div>

<div id="edit-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="font-weight:900; margin:0;" id="form-title">AJOUTER RADIO</h2>
        <i data-lucide="x" onclick="document.getElementById('edit-panel').style.display='none'"></i>
    </div>
    <div style="text-align:center; margin-bottom:20px;"><img id="form-preview" src="https://i.imgur.com/vsqN1NZ.png" style="width:120px; height:120px; border-radius:50%; border:2px solid var(--contrast-border); object-fit:cover;"></div>
    <input type="hidden" id="edit-id">
    <div class="form-group"><label>NOM DE LA RADIO</label><input type="text" id="f-name"></div>
    <div class="form-group"><label>URL DU FLUX (STREAM)</label><input type="text" id="f-url"></div>
    <div class="form-group"><label>CATÉGORIE</label>
        <div style="display:flex; gap:10px;">
            <select id="f-cat-select" onchange="if(this.value==='NEW'){document.getElementById('f-cat-new').style.display='block'}else{document.getElementById('f-cat-new').style.display='none'}"></select>
        </div>
        <input type="text" id="f-cat-new" placeholder="Nom de la nouvelle catégorie" style="display:none; margin-top:10px;">
    </div>
    <div class="form-group">
        <label>URL LOGO (WEB)</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="f-logo" oninput="document.getElementById('form-preview').src=this.value" style="flex:1;">
            <button onclick="searchLogoOnGoogle()" style="background:var(--accent); color:var(--contrast-text); border:2px solid #fff; border-radius:12px; padding:0 15px; font-weight:900; cursor:pointer;"><i data-lucide="search" size="20"></i></button>
        </div>
    </div>
    <div class="form-group"><label>OU IMAGE LOCALE</label><input type="file" id="f-file" accept="image/*" onchange="previewLocalImage(this)"></div>
    <button onclick="saveRadio()" style="width:100%; background:var(--accent); color:var(--contrast-text); padding:20px; border-radius:15px; font-weight:900; border:2px solid var(--contrast-border); margin-top:10px;">ENREGISTRER</button>
    <button id="btn-delete-radio" onclick="deleteRadio()" style="display:none; width:100%; background:#ff4444; color:#fff; padding:15px; border-radius:15px; font-weight:900; border:none; margin-top:15px; cursor:pointer;">SUPPRIMER CETTE RADIO</button>
</div>

<div id="settings-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:40px;">
        <h2 style="font-weight:900; margin:0;">PERSONNALISATION</h2>
        <i data-lucide="x" onclick="toggleSettings(false)"></i>
    </div>
    <div class="color-row">
        <label style="font-weight:900;">COULEUR ACCENT</label>
        <input type="color" id="accent-picker" oninput="updateStyle('accent', this.value)">
    </div>
    <div class="color-row">
        <label style="font-weight:900;">COULEUR VISU</label>
        <input type="color" id="viz-picker" oninput="updateStyle('viz', this.value)">
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
        <button onclick="exportFavs()" style="padding:15px; border-radius:12px; background:#fff; color:#000; font-weight:800; border:none;">SAUVEGARDER</button>
        <button onclick="document.getElementById('import-input').click()" style="padding:15px; border-radius:12px; background:#fff; color:#000; font-weight:800; border:none;">IMPORTER</button>
    </div>
    <input type="file" id="import-input" hidden onchange="importFavs(this)">
</div>

<script>
    let favorites = [], currentStation = null, isPlaying = false, vizMode = 'bars', searchTimer;
    let config = { bg: '#000000', accent: '#ffffff', viz: '#000000' };
    let audio = new Audio(), audioCtx, analyser, dataArray;
    let pressTimer, catPressTimer;
    audio.crossOrigin = "anonymous";

    document.addEventListener('fullscreenchange', handleFSChange);
    document.addEventListener('webkitfullscreenchange', handleFSChange);
    document.addEventListener('mozfullscreenchange', handleFSChange);
    document.addEventListener('MSFullscreenChange', handleFSChange);

    function handleFSChange() {
        const isFS = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        const btn = document.getElementById('btn-fix-fs');
        if (btn) {
            btn.style.display = isFS ? 'none' : 'flex';
        }
    }

    function getLuminance(hex) {
        const rgb = hex.replace(/^#/, '').match(/.{2}/g).map(x => parseInt(x, 16) / 255);
        const [r, g, b] = rgb.map(c => c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4));
        return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    function updateStyle(k, v) {
        document.documentElement.style.setProperty(`--${k}`, v);
        config[k] = v;
        localStorage.setItem(`ELITE_${k}`, v);
        
        if (k === 'accent') {
            const lum = getLuminance(v);
            
            // 1. Texte sur les boutons (Noir ou Blanc)
            document.documentElement.style.setProperty('--contrast-text', lum > 0.5 ? '#000' : '#fff');
            
            // 2. Sécurité Horloge : Si l'accent est trop noir, on force le blanc
            const clockCol = lum < 0.2 ? '#ffffff' : v;
            document.documentElement.style.setProperty('--clock-color', clockCol);
            
            // 3. Sécurité Contours : Si l'accent est trop noir, on force une bordure blanche
            // Ajout d'un seuil plus strict pour les bordures
            const borderCol = lum < 0.3 ? '#ffffff' : v;
            document.documentElement.style.setProperty('--contrast-border', borderCol);
        }
    }

    function loadSavedStyles() {
        const savedAccent = localStorage.getItem('ELITE_accent') || '#ffffff';
        const savedViz = localStorage.getItem('ELITE_viz') || '#000000';
        updateStyle('accent', savedAccent);
        updateStyle('viz', savedViz);
        document.getElementById('accent-picker').value = savedAccent;
        document.getElementById('viz-picker').value = savedViz;
    }

    const openDB = () => new Promise(res => {
        let req = indexedDB.open("RADIO_ELITE_DB", 3);
        req.onupgradeneeded = e => { 
            let db = e.target.result;
            if(!db.objectStoreNames.contains("favs")) db.createObjectStore("favs", {keyPath: "id", autoIncrement: true}); 
        };
        req.onsuccess = e => res(e.target.result);
    });

    function startPress(id, station) { 
        pressTimer = setTimeout(() => { openEditForm(id, station); }, 4000); 
    }
    function cancelPress() { clearTimeout(pressTimer); }

    function startCatPress(oldName) {
        catPressTimer = setTimeout(() => { renameCategory(oldName); }, 4000);
    }
    function cancelCatPress() { clearTimeout(catPressTimer); }

    async function renameCategory(oldName) {
        const newName = prompt("Nouveau nom pour la catégorie '" + oldName + "' :", oldName);
        if (!newName || newName === oldName) return;

        const db = await openDB();
        const tx = db.transaction("favs", "readwrite");
        const store = tx.objectStore("favs");
        
        favorites.forEach(f => {
            if ((f.cat || 'Général') === oldName) {
                f.cat = newName;
                store.put(f);
            }
        });

        tx.oncomplete = () => { loadFavData(); };
    }

    function autoSearch() { 
        clearTimeout(searchTimer); 
        searchTimer = setTimeout(searchRadios, 600); 
    }

    async function searchRadios() {
        const q = document.getElementById('radio-q').value;
        if(!q || q.length < 2) {
            document.getElementById('search-results').innerHTML = "";
            return;
        }
        try {
            const res = await fetch(`https://all.api.radio-browser.info/json/stations/byname/${encodeURIComponent(q)}`);
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            renderSearch(data);
        } catch(e) { console.error("Erreur Recherche:", e); }
    }

    function renderSearch(data) {
        const container = document.getElementById('search-results');
        container.innerHTML = "";
        data.slice(0, 9999).forEach(s => {
            const logoUrl = s.favicon || 'https://i.imgur.com/vsqN1NZ.png';
            const stationObj = {name: s.name, url: s.url_resolved, logo: logoUrl, cat: 'Général'};
            const isFav = favorites.some(f => f.url === s.url_resolved);
            const isCurrent = currentStation && currentStation.url === s.url_resolved;
            
            const card = document.createElement('div');
            card.className = `music-card ${isCurrent ? 'playing-this' : ''}`;
            card.dataset.stationUrl = s.url_resolved; 
            
            card.onmousedown = () => startPress(null, stationObj);
            card.ontouchstart = () => startPress(null, stationObj);
            card.onmouseup = cancelPress;
            card.ontouchend = cancelPress;
            
            card.onclick = (e) => { playStation(stationObj, card); };

            card.innerHTML = `
                <i data-lucide="star" class="card-fav-icon ${isFav ? 'is-fav' : ''}" onclick="event.stopPropagation(); toggleFav('${s.url_resolved}', '${s.name.replace(/'/g, "\\'")}', '${logoUrl}')"></i>
                <img src="${logoUrl}" class="card-art ${isCurrent && isPlaying ? 'is-spinning' : ''}">
                <div class="title-box"><span class="marquee">${s.name}</span></div>`;
            container.appendChild(card);
        });
        lucide.createIcons(); 
        checkMarquees();
    }

    async function toggleFav(url, name, logo) {
        const db = await openDB();
        const tx = db.transaction("favs", "readwrite");
        const store = tx.objectStore("favs");
        const existing = favorites.find(f => f.url === url);
        if(existing) { 
            store.delete(existing.id); 
            tx.oncomplete = () => { loadFavData().then(() => searchRadios()); }; 
        } else { 
            const newRadio = {name, url, logo: logo || 'https://i.imgur.com/vsqN1NZ.png', cat: 'Général'};
            store.add(newRadio).onsuccess = (e) => { 
                tx.oncomplete = () => { 
                    loadFavData().then(() => {
                        searchRadios();
                        openEditForm(e.target.result); 
                    });
                }; 
            };
        }
    }

    function playStation(station, element = null) {
        currentStation = station;
        audio.src = station.url;
        audio.play().then(() => {
            updateMediaSession();
        }).catch(() => console.log("Auto-play bloqué ou flux invalide"));
        
        isPlaying = true;
        document.getElementById('mini-art').src = station.logo;
        document.getElementById('fs-art').src = station.logo;
        document.getElementById('mini-title').innerText = station.name;
        document.getElementById('fs-title').innerText = station.name;
        
        if(!audioCtx) initAudio();
        updateIcons(); 
        checkMarquees();
        
        if (element) {
            setTimeout(() => {
                const pos = element.getBoundingClientRect().top + window.pageYOffset - 15;
                window.scrollTo({ top: pos, behavior: 'smooth' });
            }, 100);
        }
    }

    function updateMediaSession() {
        if ('mediaSession' in navigator && currentStation) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: currentStation.name,
                artist: "RADIOLINKY",
                artwork: [{ src: currentStation.logo, sizes: '512x512', type: 'image/png' }]
            });
            navigator.mediaSession.setActionHandler('play', () => togglePlay());
            navigator.mediaSession.setActionHandler('pause', () => togglePlay());
        }
    }

    function togglePlay() { 
        if (isPlaying) { audio.pause(); } else { audio.play(); }
        isPlaying = !isPlaying; 
        updateIcons(); 
    }

    function updateIcons() {
        const icon = isPlaying ? 'pause' : 'play';
        document.getElementById('btn-play-mini').setAttribute('data-lucide', icon);
        document.getElementById('btn-play-fs').setAttribute('data-lucide', icon);
        
        const miniImg = document.getElementById('mini-art');
        const fsImg = document.getElementById('fs-art');
        if(miniImg) isPlaying ? miniImg.classList.add('is-spinning') : miniImg.classList.remove('is-spinning');
        if(fsImg) isPlaying ? fsImg.classList.add('is-spinning') : fsImg.classList.remove('is-spinning');

        document.querySelectorAll('.music-card').forEach(card => {
            const img = card.querySelector('.card-art');
            const cardUrl = card.dataset.stationUrl;
            
            if(currentStation && cardUrl === currentStation.url) {
                card.classList.add('playing-this');
                if(img) {
                    if(isPlaying) { img.classList.add('is-spinning'); } 
                    else { img.classList.remove('is-spinning'); }
                }
            } else {
                card.classList.remove('playing-this');
                if(img) img.classList.remove('is-spinning');
            }
        });

        lucide.createIcons();
    }

    function switchTab(tab) {
        document.getElementById('section-search').style.display = tab === 'search' ? 'block' : 'none';
        document.getElementById('section-favs').style.display = tab === 'favs' ? 'block' : 'none';
        document.getElementById('tab-search').classList.toggle('active', tab === 'search');
        document.getElementById('tab-favs').classList.toggle('active', tab === 'favs');
        if(tab === 'favs') loadFavData();
        lucide.createIcons();
    }

    async function loadFavData() {
        const db = await openDB();
        return new Promise(resolve => {
            db.transaction("favs").objectStore("favs").getAll().onsuccess = (e) => {
                favorites = e.target.result;
                const container = document.getElementById('favs-accordion-container');
                container.innerHTML = "";
                
                const cats = [...new Set(favorites.map(f => f.cat || 'Général'))].sort((a, b) => a.localeCompare(b));
                
                cats.forEach(cat => {
                    const group = document.createElement('div');
                    group.className = "category-group";
                    
                    const catFavs = favorites
                        .filter(f => (f.cat || 'Général') === cat)
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    const header = document.createElement('div');
                    header.className = "cat-header";
                    header.innerHTML = `<span>${cat.toUpperCase()} (${catFavs.length})</span><i data-lucide="chevron-down"></i>`;
                    
                    header.onmousedown = () => startCatPress(cat);
                    header.ontouchstart = () => startCatPress(cat);
                    header.onmouseup = cancelCatPress;
                    header.ontouchend = cancelCatPress;
                    header.onclick = () => toggleAccordion(header);

                    group.appendChild(header);

                    const grid = document.createElement('div');
                    grid.className = "grid-container";
                    grid.style.display = "none";
                    grid.innerHTML = catFavs.map(f => {
                                const isCurrent = currentStation && currentStation.url === f.url;
                                const isSpinning = isCurrent && isPlaying ? 'is-spinning' : '';
                                const stationJson = JSON.stringify(f).replace(/'/g, "\\'");
                                return `<div class="music-card ${isCurrent ? 'playing-this' : ''}" 
                                            data-station-url="${f.url}"
                                            onmousedown="startPress(${f.id})" ontouchstart="startPress(${f.id})"
                                            onmouseup="cancelPress()" ontouchend="cancelPress()"
                                            onclick='playStation(${stationJson}, this)'>
                                    <img src="${f.logo}" class="card-art ${isSpinning}">
                                    <div class="title-box"><span class="marquee">${f.name}</span></div>
                                </div>`}).join('');
                    
                    group.appendChild(grid);
                    container.appendChild(group);
                });
                lucide.createIcons(); checkMarquees(); resolve();
            };
        });
    }

    function toggleAccordion(el) {
        const grid = el.nextElementSibling;
        const isOpen = grid.style.display === 'grid';
        grid.style.display = isOpen ? 'none' : 'grid';
        if (!isOpen) {
            setTimeout(() => {
                el.scrollIntoView({behavior: 'smooth', block: 'start'});
                checkMarquees();
                updateIcons(); 
            }, 300);
        }
    }

    function previewLocalImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { document.getElementById('form-preview').src = e.target.result; document.getElementById('f-logo').value = e.target.result; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function searchLogoOnGoogle() {
        const radioName = document.getElementById('f-name').value;
        if (!radioName) {
            alert("VEUILLEZ D'ABORD SAISIR LE NOM DE LA RADIO");
            return;
        }
        const query = encodeURIComponent(radioName + " radio logo png");
        window.open(`https://www.google.com/search?q=${query}&tbm=isch`, '_blank');
    }

    async function saveRadio() {
        const db = await openDB();
        const tx = db.transaction("favs", "readwrite");
        const store = tx.objectStore("favs");
        let category = document.getElementById('f-cat-select').value;
        if(category === 'NEW') category = document.getElementById('f-cat-new').value || 'Général';
        const radio = { name: document.getElementById('f-name').value, url: document.getElementById('f-url').value, logo: document.getElementById('f-logo').value || 'https://i.imgur.com/vsqN1NZ.png', cat: category };
        const id = document.getElementById('edit-id').value;
        if(id) radio.id = parseInt(id);
        store.put(radio);
        tx.oncomplete = () => { document.getElementById('edit-panel').style.display='none'; loadFavData(); };
    }

    async function deleteRadio() {
        const id = document.getElementById('edit-id').value;
        if(!id || !confirm("Supprimer cette radio ?")) return;
        const db = await openDB();
        const tx = db.transaction("favs", "readwrite");
        tx.objectStore("favs").delete(parseInt(id));
        tx.oncomplete = () => { document.getElementById('edit-panel').style.display='none'; loadFavData(); };
    }

    function openEditForm(id = null, station = null) {
        cancelPress();
        document.getElementById('edit-panel').style.display = 'block';
        const select = document.getElementById('f-cat-select');
        const uniqueCats = [...new Set(favorites.map(f => f.cat || 'Général'))].sort((a, b) => a.localeCompare(b));
        select.innerHTML = uniqueCats.map(c => `<option value="${c}">${c}</option>`).join('') + '<option value="NEW">+ Nouvelle catégorie</option>';
        
        const deleteBtn = document.getElementById('btn-delete-radio');
        
        if(!id && !station) {
            document.getElementById('f-name').value = ""; 
            document.getElementById('f-url').value = "";
            document.getElementById('f-logo').value = ""; 
            document.getElementById('edit-id').value = "";
            document.getElementById('form-preview').src = 'https://i.imgur.com/vsqN1NZ.png';
            deleteBtn.style.display = 'none';
        } else if(id) {
            const f = favorites.find(x => x.id === id);
            document.getElementById('f-name').value = f.name; 
            document.getElementById('f-url').value = f.url;
            document.getElementById('f-logo').value = f.logo; 
            document.getElementById('edit-id').value = f.id;
            document.getElementById('f-cat-select').value = f.cat || 'Général'; 
            document.getElementById('form-preview').src = f.logo;
            deleteBtn.style.display = 'block';
        } else if(station) {
            document.getElementById('f-name').value = station.name; 
            document.getElementById('f-url').value = station.url;
            document.getElementById('f-logo').value = station.logo; 
            document.getElementById('edit-id').value = "";
            document.getElementById('form-preview').src = station.logo;
            deleteBtn.style.display = 'none';
        }
        lucide.createIcons();
    }

    async function exportFavs() {
        const db = await openDB();
        db.transaction("favs").objectStore("favs").getAll().onsuccess = (e) => {
            const blob = new Blob([JSON.stringify(e.target.result, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = "radiolinky_favs.json"; a.click();
        };
    }

    function importFavs(input) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                const radiosToImport = Array.isArray(data) ? data : (data.radios || []);
                const db = await openDB();
                const tx = db.transaction("favs", "readwrite");
                const store = tx.objectStore("favs");
                const existingUrls = new Set(favorites.map(f => f.url));
                let count = 0;
                radiosToImport.forEach(r => {
                    const url = r.url;
                    if (url && !existingUrls.has(url)) {
                        store.add({
                            name: r.name, 
                            url: url, 
                            logo: r.logo || r.image || 'https://i.imgur.com/vsqN1NZ.png', 
                            cat: r.cat || r.category || 'Général'
                        });
                        existingUrls.add(url);
                        count++;
                    }
                });
                tx.oncomplete = () => { loadFavData(); alert(count + " radios ajoutées avec succès !"); };
            } catch(err) { alert("Erreur lors de l'importation du JSON"); }
        };
        reader.readAsText(input.files[0]);
    }

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser(); analyser.fftSize = 512;
        audioCtx.createMediaElementSource(audio).connect(analyser);
        analyser.connect(audioCtx.destination);
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        draw();
    }

    function draw() {
        requestAnimationFrame(draw); if (!analyser) return;
        analyser.getByteFrequencyData(dataArray);
        const canvas = document.getElementById('fs-viz'); const ctx = canvas.getContext('2d');
        const cCan = document.getElementById('viz-circle'); const cCtx = cCan.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = 200;
        ctx.clearRect(0, 0, canvas.width, canvas.height); cCtx.clearRect(0, 0, 340, 340);
        
        const themeColor = config.viz; const secondaryColor = "#ffffff";
        let lowFreqSum = 0; for(let j = 0; j < 4; j++) { lowFreqSum += dataArray[j]; }
        let lowFreqAvg = lowFreqSum / 4;
        let scaleValue = 1 + (lowFreqAvg / 255) * 0.25;
        document.getElementById('fs-art').style.transform = `scale(${scaleValue})`;
        document.getElementById('fs-art').style.boxShadow = `0 0 ${1 + (lowFreqAvg / 20)}px var(--accent), 0 0 ${2 + (lowFreqAvg / 10)}px ${secondaryColor}`;

        if(vizMode === 'bars' || vizMode === 'both') {
            const bufferLength = 64; const barWidth = canvas.width / bufferLength; let x = 0;
            for (let i = 0; i < bufferLength; i++) {
                const valRaw = dataArray[i * 2]; const val = Math.pow(valRaw / 255, 1.2) * 255;
                const barHeight = (val / 255) * canvas.height;
                if (barHeight > 0) {
                    const actualBarWidth = barWidth - 4; const barY = canvas.height - barHeight;
                    let grad = ctx.createLinearGradient(0, canvas.height, 0, barY);
                    grad.addColorStop(0, "rgba(0,0,0,0.2)"); grad.addColorStop(0.5, themeColor); grad.addColorStop(1, secondaryColor);
                    ctx.fillStyle = grad; ctx.beginPath(); ctx.roundRect(x, barY, actualBarWidth, barHeight, [15, 15, 0, 0]); ctx.fill();
                    ctx.fillStyle = "#ff0000"; ctx.beginPath(); ctx.arc(x + (actualBarWidth/2), barY + 1, 1.2, 0, Math.PI*2); ctx.fill();
                }
                x += barWidth;
            }
        }

        if(vizMode === 'circle' || vizMode === 'both') {
            cCtx.save(); cCtx.translate(170, 170); const bars = 120; const radius = 108; 
            for (let i = 0; i < bars; i++) {
                const angle = i * ((Math.PI * 2) / bars); const dataIdx = Math.abs((i % 80) - 40);
                const val = Math.pow(dataArray[dataIdx] / 255, 1.2) * 255; const h = (val / 255) * 65;
                const xEnd = Math.cos(angle) * (radius + h); const yEnd = Math.sin(angle) * (radius + h);
                let grad = cCtx.createRadialGradient(0, 0, radius, 0, 0, radius + h);
                grad.addColorStop(0, "rgba(0,0,0,0.1)"); grad.addColorStop(0.5, themeColor); grad.addColorStop(1, secondaryColor);
                cCtx.strokeStyle = grad; cCtx.lineWidth = 2.8; cCtx.lineCap = "round";
                cCtx.beginPath(); cCtx.moveTo(Math.cos(angle)*radius, Math.sin(angle)*radius); cCtx.lineTo(xEnd, yEnd); cCtx.stroke();
                if(h > 2) { cCtx.fillStyle = "#ff0000"; cCtx.beginPath(); cCtx.arc(xEnd, yEnd, 1.3, 0, Math.PI*2); cCtx.fill(); }
            }
            cCtx.restore();
        }
    }

    function requestFullScreen() {
        const docEl = document.documentElement;
        const req = docEl.requestFullscreen || docEl.webkitRequestFullScreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen;
        if (req) req.call(docEl).catch(() => {});
    }

    function openFullscreen() {
        const player = document.getElementById('fullscreen-player');
        player.style.display = 'flex';
        handleFSChange();
        checkMarquees();
    }

    function closeFullscreen() {
        document.getElementById('fullscreen-player').style.display = 'none';
        if (document.exitFullscreen) { document.exitFullscreen(); } 
        else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } 
        else if (document.msExitFullscreen) { document.msExitFullscreen(); }
    }

    function toggleSettings(s) { document.getElementById('settings-panel').style.display = s ? 'block' : 'none'; }
    
    function switchViz() {
        if (vizMode === 'bars') vizMode = 'circle';
        else if (vizMode === 'circle') vizMode = 'both';
        else if (vizMode === 'both') vizMode = 'none';
        else vizMode = 'bars';
    }

    function checkMarquees() {
        document.querySelectorAll('.title-box').forEach(box => {
            const span = box.querySelector('.marquee');
            if(span) {
                span.classList.add('no-scroll');
                if (span.scrollWidth > box.offsetWidth) {
                    span.classList.remove('no-scroll');
                    span.style.animationDuration = `${span.scrollWidth / 50}s`;
                }
            }
        });
    }

    function shareStation() { if(currentStation) navigator.share({ title: currentStation.name, url: currentStation.url }); }
    function toggleTimer() { const mins = prompt("Minutes avant extinction :"); if(mins > 0) setTimeout(() => { audio.pause(); isPlaying = false; updateIcons(); }, mins * 60000); }

    window.onload = () => { loadSavedStyles(); loadFavData(); };
    
    function updateClock() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, '0');
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        const clockElement = document.getElementById('fs-clock');
        if (clockElement) clockElement.innerText = `${h}:${m}:${s}`;
    }

    setInterval(updateClock, 1000);
    updateClock();

</script>
</body>
</html>
